# 🎯 AI求人マッチングシステム - 最適化＆マッチング率向上プロセス完全ガイド

---

## 📊 目次

1. [システム全体フロー](#1-システム全体フロー)
2. [ユーザー登録〜マッチングフロー](#2-ユーザー登録マッチングフロー)
3. [データ収集＆蓄積フロー](#3-データ収集蓄積フロー)
4. [マッチングアルゴリズムフロー](#4-マッチングアルゴリズムフロー)
5. [データベース最適化フロー](#5-データベース最適化フロー)
6. [継続的改善フロー](#6-継続的改善フロー)

---

# 1. システム全体フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                     AI求人マッチングシステム                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │         ユーザー登録・プロフィール入力          │
        │   - メールアドレス・パスワード               │
        │   - 基本情報（職種、勤務地、希望年収）        │
        └──────────────────┬──────────────────┘
                           ▼
        ┌─────────────────────────────────────────┐
        │           初期マッチング（広範囲）             │
        │   - 基本条件でフィルタリング                 │
        │   - 43件の候補求人を表示                   │
        └──────────────────┬──────────────────┘
                           ▼
        ┌─────────────────────────────────────────┐
        │          AIによる動的質問生成               │
        │   - 求人の多様性を分析                     │
        │   - 最適な質問を自動選択                   │
        └──────────────────┬──────────────────┘
                           ▼
        ┌─────────────────────────────────────────┐
        │         ユーザーとのチャット対話              │
        │   - YES/NO質問                          │
        │   - スケール質問（1-5）                   │
        │   - 自由記述質問                         │
        └──────────────────┬──────────────────┘
                           ▼
        ┌─────────────────────────────────────────┐
        │           段階的な求人絞り込み              │
        │   43件 → 21件 → 13件 → 3件              │
        └──────────────────┬──────────────────┘
                           ▼
        ┌─────────────────────────────────────────┐
        │      最終推薦（3件以下になったら）            │
        │   1. フィルタリング済み求人（2件）           │
        │   2. エンベディング検索求人（2件）           │
        │   3. 類似ユーザーの応募求人（1件）           │
        └──────────────────┬──────────────────┘
                           ▼
        ┌─────────────────────────────────────────┐
        │          ユーザー行動の追跡・学習             │
        │   - クリック                              │
        │   - 閲覧                                 │
        │   - お気に入り                           │
        │   - 応募                                 │
        └──────────────────┬──────────────────┘
                           ▼
        ┌─────────────────────────────────────────┐
        │         次回以降のマッチング精度向上          │
        │   - 行動履歴を反映                        │
        │   - エンベディング更新                     │
        │   - 類似ユーザーの発見                     │
        └─────────────────────────────────────────┘
```

---

# 2. ユーザー登録〜マッチングフロー

## 2-1. 新規ユーザー登録フロー

```
START: ユーザーがランディングページにアクセス
  │
  ▼
┌────────────────────────────────────────────────┐
│ STEP 1: ランディングページ (/)                    │
│ - システムの説明                                  │
│ - 「今すぐ始める」ボタン                          │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 2: メールアドレス・パスワード登録 (/step1)      │
│                                                  │
│ [入力項目]                                       │
│ - 名前                                          │
│ - メールアドレス                                 │
│ - パスワード                                     │
│                                                  │
│ [データベース処理]                               │
│ 1. personal_date テーブルに挿入                  │
│    - user_id (自動採番)                         │
│    - email                                      │
│    - password_hash (ハッシュ化)                 │
│    - user_name                                  │
│                                                  │
│ 2. user_profile テーブルに初期レコード作成        │
│    - user_id                                    │
│    - その他カラムはNULL                          │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 3: 基本情報入力 (/step2)                     │
│                                                  │
│ [入力項目]                                       │
│ - 希望職種（例: デザイナー）                      │
│ - 希望勤務地（例: 東京都）                        │
│ - 希望年収（例: 450万円）                        │
│                                                  │
│ [データベース処理]                               │
│ user_profile テーブルを更新                      │
│   UPDATE user_profile SET                       │
│     job_title = 'デザイナー',                    │
│     location_prefecture = '東京都',              │
│     salary_min = 450                            │
│   WHERE user_id = ?                             │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 4: プロフィール確認 (/profile)               │
│                                                  │
│ [表示内容]                                       │
│ - 名前                                          │
│ - メールアドレス                                 │
│ - 希望職種                                       │
│ - 希望勤務地                                     │
│ - 希望年収                                       │
│                                                  │
│ [アクション]                                     │
│ - 「チャットで求人を探す」ボタン                   │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 5: チャット開始 (/chat)                      │
└────────────────────────────────────────────────┘
```

---

## 2-2. チャットマッチングフロー

```
START: ユーザーが /chat にアクセス
  │
  ▼
┌────────────────────────────────────────────────┐
│ 1. 初期マッチング（広範囲）                        │
│                                                  │
│ [処理]                                           │
│ HybridRecommender.get_hybrid_recommendations()   │
│                                                  │
│ [フィルタリング条件]                              │
│ - job_title LIKE '%デザイナー%'                   │
│ - location_prefecture = '東京都'                  │
│ - salary_min >= 450                              │
│                                                  │
│ [結果]                                           │
│ 43件の候補求人を取得                              │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 2. AIによる動的質問生成                            │
│                                                  │
│ [処理]                                           │
│ DynamicQuestionGenerator.generate_question()     │
│                                                  │
│ [分析内容]                                       │
│ - 43件の求人データを分析                          │
│ - リモートワーク: 可能21件、不可22件              │
│ - 企業規模: スタートアップ15件、大企業28件        │
│ - 研修制度: あり18件、なし25件                    │
│                                                  │
│ [質問選択]                                       │
│ → 最も分散が大きい「リモートワーク」を質問         │
│                                                  │
│ [AIが生成した質問]                               │
│ "デザインの仕事はリモートで行いたいですか？"       │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 3. ユーザーの回答を受け取る                        │
│                                                  │
│ [ユーザーの入力]                                  │
│ "リモートワークを希望します"                       │
│                                                  │
│ [処理]                                           │
│ 1. 自然言語解析                                  │
│    - "希望" → TRUE                               │
│                                                  │
│ 2. データベースに保存                             │
│    INSERT INTO user_question_responses (         │
│      user_id, question_key, response_text,       │
│      normalized_response, created_at             │
│    ) VALUES (                                    │
│      4001, 'remote',                             │
│      'リモートワークを希望します',                 │
│      'yes', NOW()                                │
│    )                                             │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 4. 求人を再フィルタリング                          │
│                                                  │
│ [フィルタリング条件（追加）]                       │
│ - remote = TRUE                                  │
│                                                  │
│ [結果]                                           │
│ 43件 → 21件に絞り込み                            │
│                                                  │
│ [ボットの応答]                                    │
│ "21件に絞り込まれました。                         │
│  企業規模について希望はありますか？"               │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 5. このプロセスを繰り返す                          │
│                                                  │
│ 質問2: "企業規模は何を希望しますか？"             │
│ 回答2: "大規模な会社がいいです"                   │
│ → 21件 → 21件（企業規模データなし）              │
│                                                  │
│ 質問3: "研修制度の有無は重視しますか？"           │
│ 回答3: "しっかりした研修制度がある方がいいです"    │
│ → 21件 → 13件                                    │
│                                                  │
│ 質問4: "副業は考えていますか？"                   │
│ 回答4: "副業にも興味があります"                   │
│ → 13件 → 3件                                     │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 6. 最終推薦（3件以下になったら）                   │
│                                                  │
│ [処理の切り替え]                                  │
│ IF 求人数 <= 3:                                  │
│   1. 会話履歴からエンベディング生成                │
│   2. エンベディング検索（類似求人）                │
│   3. 類似ユーザーの応募求人を取得                  │
│                                                  │
│ [結果]                                           │
│ - フィルタリング済み: 3件                         │
│ - エンベディング検索: 2件                         │
│ - 類似ユーザー: 1件                               │
│ 合計: 5-6件の求人を表示                           │
└────────────────────────────────────────────────┘
```

---

# 3. データ収集＆蓄積フロー

## 3-1. ユーザー行動追跡フロー

```
┌────────────────────────────────────────────────┐
│         ユーザーが求人カードをクリック              │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ JavaScript イベントハンドラ（chat.html）           │
│                                                  │
│ function handleJobClick(jobId) {                 │
│   // 1. バックエンドに送信                       │
│   fetch('/api/track', {                          │
│     method: 'POST',                              │
│     body: JSON.stringify({                       │
│       user_id: currentUserId,                    │
│       job_id: jobId,                             │
│       action: 'click'                            │
│     })                                           │
│   });                                            │
│                                                  │
│   // 2. 求人詳細ページを開く                     │
│   window.open(`/job/${jobId}`, '_blank');        │
│ }                                                │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ バックエンド（main.py）                           │
│                                                  │
│ @app.post("/api/track")                          │
│ async def track_interaction(data: dict):         │
│   user_id = data['user_id']                      │
│   job_id = data['job_id']                        │
│   action = data['action']  # click, view, etc.   │
│                                                  │
│   # データベースに記録                            │
│   INSERT INTO user_interactions (                │
│     user_id, job_id, interaction_type,           │
│     created_at                                   │
│   ) VALUES (                                     │
│     %s, %s, %s, NOW()                            │
│   )                                              │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ データベース（user_interactions テーブル）         │
│                                                  │
│ ┌────┬─────────┬────────┬─────────┬────────┐ │
│ │ id │ user_id │ job_id │ type    │ time   │ │
│ ├────┼─────────┼────────┼─────────┼────────┤ │
│ │ 1  │ 4001    │ abc123 │ click   │ 14:30  │ │
│ │ 2  │ 4001    │ abc123 │ view    │ 14:31  │ │
│ │ 3  │ 4001    │ abc123 │ favorite│ 14:35  │ │
│ │ 4  │ 4001    │ abc123 │ apply   │ 14:40  │ │
│ └────┴─────────┴────────┴─────────┴────────┘ │
└────────────────────────────────────────────────┘
```

---

## 3-2. チャット履歴蓄積フロー

```
┌────────────────────────────────────────────────┐
│        ユーザーがメッセージを送信                  │
│ "リモートワークを希望します"                       │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 1. chat_history テーブルに保存                    │
│                                                  │
│ INSERT INTO chat_history (                       │
│   user_id, sender, message, session_id, time     │
│ ) VALUES (                                       │
│   4001, 'user',                                  │
│   'リモートワークを希望します',                    │
│   'session_abc123', NOW()                        │
│ )                                                │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 2. AIが回答を生成                                 │
│                                                  │
│ bot_message = "21件に絞り込まれました。            │
│ 企業規模について希望はありますか？"                │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 3. ボットの回答も保存                             │
│                                                  │
│ INSERT INTO chat_history (                       │
│   user_id, sender, message, session_id, time     │
│ ) VALUES (                                       │
│   4001, 'bot',                                   │
│   '21件に絞り込まれました...',                    │
│   'session_abc123', NOW()                        │
│ )                                                │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 4. 会話履歴の活用                                 │
│                                                  │
│ [エンベディング生成時]                            │
│ - 過去の会話履歴を結合                            │
│ - ユーザーの本当の希望を理解                      │
│                                                  │
│ [例]                                             │
│ "リモートワークを希望します"                       │
│ "大規模な会社がいいです"                          │
│ "しっかりした研修制度がある方がいいです"           │
│ "副業にも興味があります"                          │
│                                                  │
│ → この情報からエンベディングを生成                 │
└────────────────────────────────────────────────┘
```

---

# 4. マッチングアルゴリズムフロー

## 4-1. ハイブリッドレコメンデーションフロー

```
START: HybridRecommender.get_hybrid_recommendations()
  │
  ▼
┌────────────────────────────────────────────────┐
│ 1. 協調フィルタリング（Collaborative Filtering） │
│                                                  │
│ [処理]                                           │
│ 類似ユーザーを発見                                │
│                                                  │
│ ┌──────────────────────────────┐                │
│ │ ユーザー4001の行動履歴       │                │
│ │ - 求人A: クリック            │                │
│ │ - 求人B: お気に入り          │                │
│ │ - 求人C: 応募                │                │
│ └──────────────────────────────┘                │
│          ↓ 比較                                  │
│ ┌──────────────────────────────┐                │
│ │ ユーザー3045の行動履歴       │                │
│ │ - 求人A: クリック ←共通      │                │
│ │ - 求人B: 応募 ←共通          │                │
│ │ - 求人D: 応募                │                │
│ └──────────────────────────────┘                │
│                                                  │
│ [結果]                                           │
│ ユーザー3045は類似ユーザー                        │
│ → 求人Dを推薦                                    │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 2. コンテンツベースフィルタリング                  │
│    (Content-Based Filtering)                     │
│                                                  │
│ [処理]                                           │
│ ユーザーのプロフィールに基づいて求人を検索          │
│                                                  │
│ SELECT * FROM company_profile                    │
│ WHERE                                            │
│   job_title LIKE '%デザイナー%'                   │
│   AND location_prefecture = '東京都'              │
│   AND salary_min >= 450                          │
│   AND remote = TRUE                              │
│   AND training = TRUE                            │
│   AND side_job = TRUE                            │
│                                                  │
│ [結果]                                           │
│ 3件の求人が該当                                   │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 3. スコアリング＆統合                             │
│                                                  │
│ [各求人のスコア計算]                              │
│                                                  │
│ 求人X:                                           │
│ - CF スコア: 0.8（類似ユーザーが応募）            │
│ - CB スコア: 0.9（条件完全一致）                 │
│ - 最終スコア: 0.85（重み付け平均）                │
│                                                  │
│ 求人Y:                                           │
│ - CF スコア: 0.0（類似ユーザーなし）              │
│ - CB スコア: 0.7（条件部分一致）                 │
│ - 最終スコア: 0.35                                │
│                                                  │
│ [ソート]                                         │
│ 最終スコアの高い順に並べる                         │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 4. 最終結果を返す                                 │
│                                                  │
│ [Top 5 推薦求人]                                  │
│ 1. 求人X（スコア: 0.85）                          │
│ 2. 求人Z（スコア: 0.78）                          │
│ 3. 求人W（スコア: 0.65）                          │
│ 4. 求人V（スコア: 0.52）                          │
│ 5. 求人U（スコア: 0.48）                          │
└────────────────────────────────────────────────┘
```

---

## 4-2. エンベディング検索フロー

```
START: 求人が3件以下になったらトリガー
  │
  ▼
┌────────────────────────────────────────────────┐
│ 1. ユーザーの会話履歴を取得                        │
│                                                  │
│ SELECT message FROM chat_history                 │
│ WHERE user_id = 4001                             │
│   AND sender = 'user'                            │
│ ORDER BY created_at DESC                         │
│ LIMIT 10                                         │
│                                                  │
│ [結果]                                           │
│ "リモートワークを希望します"                       │
│ "大規模な会社がいいです"                          │
│ "しっかりした研修制度がある方がいいです"           │
│ "副業にも興味があります"                          │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 2. OpenAI APIでエンベディング生成                  │
│                                                  │
│ chat_text = "                                    │
│ 希望職種: デザイナー                              │
│ 希望勤務地: 東京都                                │
│ 希望年収: 450万円以上                             │
│                                                  │
│ 会話から抽出した希望:                             │
│ - リモートワークを希望                            │
│ - 大規模な会社                                    │
│ - 研修制度が充実                                  │
│ - 副業可能                                        │
│ "                                                │
│                                                  │
│ response = openai.embeddings.create(             │
│   model="text-embedding-3-small",                │
│   input=chat_text                                │
│ )                                                │
│                                                  │
│ user_embedding = response.data[0].embedding      │
│ # 1536次元のベクトル                             │
│ # [0.123, -0.456, 0.789, ...]                    │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 3. データベースに保存                             │
│                                                  │
│ UPDATE user_profile                              │
│ SET conversation_embedding = %s::vector          │
│ WHERE user_id = 4001                             │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 4. 求人エンベディングと比較（コサイン類似度）       │
│                                                  │
│ SELECT                                           │
│   id,                                            │
│   job_title,                                     │
│   company_name,                                  │
│   1 - (embedding <=> user_embedding) as similarity│
│ FROM company_profile                             │
│ WHERE embedding IS NOT NULL                      │
│ ORDER BY embedding <=> user_embedding            │
│ LIMIT 2                                          │
│                                                  │
│ [計算例]                                         │
│ ユーザーベクトル: [0.1, 0.2, 0.3, ...]           │
│ 求人Aベクトル:    [0.15, 0.18, 0.32, ...]        │
│                                                  │
│ コサイン類似度 = 0.8234（82.34%の一致度）         │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 5. 類似度をスコアに変換して表示                    │
│                                                  │
│ [結果]                                           │
│ - Webデザイナー（マッチ度: 82.3%）                │
│ - UIデザイナー（マッチ度: 78.9%）                 │
└────────────────────────────────────────────────┘
```

---

## 4-3. 類似ユーザー検索フロー

```
START: 求人が3件以下になったらトリガー
  │
  ▼
┌────────────────────────────────────────────────┐
│ 1. ターゲットユーザーの行動履歴を取得              │
│                                                  │
│ SELECT DISTINCT job_id                           │
│ FROM user_interactions                           │
│ WHERE user_id = 4001                             │
│   AND created_at > NOW() - INTERVAL '90 days'    │
│                                                  │
│ [結果]                                           │
│ ユーザー4001が興味を持った求人:                   │
│ - 求人A                                          │
│ - 求人B                                          │
│ - 求人C                                          │
│ - 求人D                                          │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 2. 同じ求人に興味を持ったユーザーを検索            │
│                                                  │
│ SELECT                                           │
│   ui2.user_id,                                   │
│   COUNT(DISTINCT ui1.job_id) as common_jobs      │
│ FROM user_interactions ui1                       │
│ JOIN user_interactions ui2                       │
│   ON ui1.job_id = ui2.job_id                     │
│ WHERE ui1.user_id = 4001                         │
│   AND ui2.user_id != 4001                        │
│   AND ui2.user_id BETWEEN 3000 AND 3999          │
│ GROUP BY ui2.user_id                             │
│ ORDER BY common_jobs DESC                        │
│ LIMIT 10                                         │
│                                                  │
│ [結果]                                           │
│ ┌─────────┬─────────────┐                      │
│ │ user_id │ common_jobs │                      │
│ ├─────────┼─────────────┤                      │
│ │ 3045    │ 3           │ ← 3件共通            │
│ │ 3123    │ 2           │                      │
│ │ 3089    │ 2           │                      │
│ └─────────┴─────────────┘                      │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 3. 類似ユーザーが応募した求人を取得                │
│                                                  │
│ SELECT                                           │
│   cp.id,                                         │
│   cp.job_title,                                  │
│   cd.company_name,                               │
│   COUNT(*) as apply_count                        │
│ FROM user_interactions ui                        │
│ JOIN company_profile cp ON ui.job_id = cp.id    │
│ JOIN company_date cd ON cp.company_id = cd.id   │
│ WHERE ui.user_id IN (3045, 3123, 3089)           │
│   AND ui.interaction_type = 'apply'              │
│   AND ui.user_id != 4001                         │
│ GROUP BY cp.id, cp.job_title, cd.company_name    │
│ ORDER BY apply_count DESC                        │
│ LIMIT 1                                          │
│                                                  │
│ [結果]                                           │
│ UIデザイナー（3人の類似ユーザーが応募）            │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 4. 推薦結果に追加                                 │
│                                                  │
│ [最終推薦リスト]                                  │
│ - フィルタリング済み: 3件                         │
│ - エンベディング検索: 2件                         │
│ - 類似ユーザー: 1件 ← NEW!                       │
│                                                  │
│ 合計: 6件の求人を表示                             │
└────────────────────────────────────────────────┘
```

---

# 5. データベース最適化フロー

## 5-1. データ増加シミュレーション

```
時間経過 → データ量の増加
  │
  ├─ 1ヶ月後
  │  ├─ ユーザー: 1,000人
  │  ├─ 求人: 1,000件
  │  ├─ ユーザー行動: 100,000件  ← 増加速度が速い
  │  └─ チャット履歴: 5,000件
  │
  ├─ 6ヶ月後
  │  ├─ ユーザー: 5,000人
  │  ├─ 求人: 3,000件
  │  ├─ ユーザー行動: 500,000件  ← 問題！
  │  └─ チャット履歴: 25,000件
  │
  └─ 1年後
     ├─ ユーザー: 10,000人
     ├─ 求人: 5,000件
     ├─ ユーザー行動: 1,000,000件  ← 深刻！
     └─ チャット履歴: 50,000件
```

---

## 5-2. アーカイブ戦略フロー

```
┌────────────────────────────────────────────────┐
│     毎月1日に実行（自動バッチ）                    │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 1: 90日以上前のデータを特定                   │
│                                                  │
│ SELECT COUNT(*)                                  │
│ FROM user_interactions                           │
│ WHERE created_at < NOW() - INTERVAL '90 days'    │
│                                                  │
│ [結果] 50,000件が該当                             │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 2: アーカイブテーブルに移動                   │
│                                                  │
│ INSERT INTO user_interactions_archive            │
│ SELECT *, NOW() as archived_at                   │
│ FROM user_interactions                           │
│ WHERE created_at < NOW() - INTERVAL '90 days'    │
│                                                  │
│ [結果] 50,000件をアーカイブ                       │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 3: 本テーブルから削除                        │
│                                                  │
│ DELETE FROM user_interactions                    │
│ WHERE created_at < NOW() - INTERVAL '90 days'    │
│                                                  │
│ [結果] 50,000件を削除                             │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 4: 集約データを生成（削除前）                 │
│                                                  │
│ INSERT INTO user_interaction_monthly_summary     │
│ SELECT                                           │
│   user_id,                                       │
│   DATE_TRUNC('month', created_at) as month,      │
│   COUNT(*) as total,                             │
│   COUNT(*) FILTER (WHERE type='apply') as applies│
│ FROM user_interactions_archive                   │
│ WHERE archived_at >= NOW() - INTERVAL '1 day'    │
│ GROUP BY user_id, month                          │
│                                                  │
│ [結果] 1,000行の集約データを生成                  │
│ （50,000行 → 1,000行に圧縮）                      │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 5: 1年以上前のアーカイブを削除                │
│                                                  │
│ DELETE FROM user_interactions_archive            │
│ WHERE created_at < NOW() - INTERVAL '365 days'   │
│                                                  │
│ [結果]                                           │
│ 古いデータは集約済みなので削除しても問題なし       │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ 結果: ストレージ削減                              │
│                                                  │
│ [削減効果]                                       │
│ - 本テーブル: 100,000件 → 50,000件（-50%）       │
│ - アーカイブ: 100,000件（圧縮）                  │
│ - 集約データ: 1,000件（統計分析用）               │
│                                                  │
│ [クエリ速度向上]                                  │
│ - 本テーブルのサイズ: 50% 削減                   │
│ - インデックススキャン: 2倍高速化                │
└────────────────────────────────────────────────┘
```

---

## 5-3. パーティショニング戦略フロー

```
従来の単一テーブル:
┌────────────────────────────────────┐
│ user_interactions (1,000,000件)    │
│ ├─ 2025年1月: 100,000件            │
│ ├─ 2025年2月: 100,000件            │
│ ├─ 2025年3月: 100,000件            │
│ └─ ...                             │
└────────────────────────────────────┘
       ↓ 問題: 全件スキャンが遅い
       
パーティショニング後:
┌────────────────────────────────────┐
│ user_interactions_partitioned      │
│ （親テーブル）                      │
└────────────────────────────────────┘
       ├─ user_interactions_2025_01 (100,000件)
       ├─ user_interactions_2025_02 (100,000件)
       ├─ user_interactions_2025_03 (100,000件)
       └─ ...

クエリ実行時:
┌────────────────────────────────────────────────┐
│ SELECT * FROM user_interactions                  │
│ WHERE user_id = 4001                             │
│   AND created_at >= '2025-03-01'                 │
│                                                  │
│ [従来]                                           │
│ 全10パーティション（1,000,000件）をスキャン       │
│ → 実行時間: 2秒                                  │
│                                                  │
│ [パーティショニング後]                            │
│ user_interactions_2025_03 のみスキャン            │
│ （100,000件のみ）                                │
│ → 実行時間: 0.2秒（10倍高速）                    │
└────────────────────────────────────────────────┘
```

---

## 5-4. インデックス最適化フロー

```
問題: クエリが遅い
  │
  ▼
┌────────────────────────────────────────────────┐
│ STEP 1: 問題のクエリを特定                        │
│                                                  │
│ EXPLAIN ANALYZE                                  │
│ SELECT * FROM user_interactions                  │
│ WHERE user_id = 4001                             │
│   AND created_at > NOW() - INTERVAL '90 days'    │
│                                                  │
│ [実行計画]                                       │
│ Seq Scan on user_interactions  ← 全件スキャン!  │
│   Filter: (user_id = 4001 AND ...)               │
│   Rows: 1000000                                  │
│   Time: 2000ms                                   │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 2: 適切なインデックスを作成                  │
│                                                  │
│ CREATE INDEX idx_interactions_user_created       │
│ ON user_interactions(user_id, created_at DESC);  │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ STEP 3: クエリを再実行                            │
│                                                  │
│ EXPLAIN ANALYZE                                  │
│ SELECT * FROM user_interactions                  │
│ WHERE user_id = 4001                             │
│   AND created_at > NOW() - INTERVAL '90 days'    │
│                                                  │
│ [実行計画（改善後）]                              │
│ Index Scan using idx_interactions_user_created   │
│   Index Cond: (user_id = 4001 AND ...)           │
│   Rows: 100                                      │
│   Time: 20ms  ← 100倍高速！                      │
└────────────────────────────────────────────────┘
```

---

# 6. 継続的改善フロー

## 6-1. データ収集→分析→改善サイクル

```
┌────────────────────────────────────────────────┐
│ フェーズ1: データ収集（常時実行）                  │
│                                                  │
│ ユーザー行動を記録:                               │
│ - クリック率                                     │
│ - 閲覧時間                                       │
│ - お気に入り率                                   │
│ - 応募率                                         │
│ - マッチング成功率                                │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ フェーズ2: 週次分析                               │
│                                                  │
│ SELECT                                           │
│   DATE_TRUNC('week', created_at) as week,        │
│   COUNT(*) FILTER (WHERE type='click') as clicks,│
│   COUNT(*) FILTER (WHERE type='apply') as applies│
│ FROM user_interactions                           │
│ GROUP BY week                                    │
│ ORDER BY week DESC                               │
│ LIMIT 4                                          │
│                                                  │
│ [分析結果]                                       │
│ - 応募率: 5% → 8%（改善傾向）                    │
│ - クリック率: 30% → 35%（改善傾向）              │
│ - マッチング精度: 70% → 75%（改善傾向）          │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ フェーズ3: 問題の特定                             │
│                                                  │
│ [発見した問題]                                    │
│ 1. ユーザーがすぐに離脱する求人の特徴:            │
│    - 年収が低い                                  │
│    - リモートワーク不可                          │
│                                                  │
│ 2. 応募率が高い求人の特徴:                       │
│    - 研修制度あり                                │
│    - フレックスタイム                            │
│    - 企業文化の説明が詳しい                      │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ フェーズ4: 改善施策の実施                         │
│                                                  │
│ [施策1] エンベディング生成の改善                  │
│ - 「研修制度」の重要度を上げる                    │
│ - 「企業文化」の説明を詳しく含める                │
│                                                  │
│ [施策2] 質問の優先順位変更                       │
│ - 「研修制度」の質問を早めに出す                  │
│ - 「リモートワーク」の質問を優先                  │
│                                                  │
│ [施策3] データベースの更新                       │
│ ALTER TABLE company_profile ADD COLUMN           │
│   company_culture TEXT,                          │
│   learning_support BOOLEAN                       │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ フェーズ5: A/Bテスト                              │
│                                                  │
│ ┌─────────────────┐  ┌─────────────────┐     │
│ │ グループA（従来）│  │ グループB（改善）│     │
│ │ - 応募率: 8%    │  │ - 応募率: 12%   │     │
│ └─────────────────┘  └─────────────────┘     │
│                                                  │
│ [結果]                                           │
│ グループBの方が50%改善！                          │
│ → 全ユーザーに展開                               │
└──────────────────┬─────────────────────┘
                   ▼
┌────────────────────────────────────────────────┐
│ フェーズ6: 継続的なモニタリング                    │
│                                                  │
│ ダッシュボードで監視:                             │
│ - マッチング成功率（目標: 80%以上）               │
│ - 応募率（目標: 10%以上）                        │
│ - ユーザー満足度（目標: 4.0/5以上）              │
│ - システムレスポンス時間（目標: 1秒以内）         │
└────────────────────────────────────────────────┘
```

---

## 6-2. マッチング精度向上のPDCAサイクル

```
┌─────────────────────────────────────────────┐
│ PLAN（計画）                                  │
│                                               │
│ [目標設定]                                    │
│ - マッチング精度を70% → 80%に向上             │
│                                               │
│ [仮説]                                        │
│ - ユーザーの「キャリア目標」を聞けば           │
│   より適切な求人を推薦できる                   │
└─────────────────┬───────────────────────┘
                  ▼
┌─────────────────────────────────────────────┐
│ DO（実行）                                    │
│                                               │
│ [実装]                                        │
│ 1. user_profile に career_goal カラム追加     │
│ 2. 質問システムに追加:                        │
│    "3年後、どのようなキャリアを目指していますか？" │
│ 3. エンベディング生成にキャリア目標を含める    │
└─────────────────┬───────────────────────┘
                  ▼
┌─────────────────────────────────────────────┐
│ CHECK（評価）                                 │
│                                               │
│ [データ収集]                                  │
│ - 2週間運用                                   │
│ - 応募率: 8% → 10%（+25%）                   │
│ - マッチング精度: 70% → 76%（+6%）           │
│                                               │
│ [ユーザーフィードバック]                      │
│ - 「より自分に合った求人が出てきた」（80%）   │
│ - 「質問が長すぎる」（15%）                   │
└─────────────────┬───────────────────────┘
                  ▼
┌─────────────────────────────────────────────┐
│ ACT（改善）                                   │
│                                               │
│ [次の施策]                                    │
│ 1. 質問を簡潔にする（成功）                   │
│ 2. 「学びたいスキル」も聞く（次の仮説）        │
│ 3. 企業文化のマッチングを強化                  │
└─────────────────────────────────────────────┘
       │
       └──→ PLAN に戻る（継続的改善）
```

---

# 📈 成果指標のダッシュボード

```
┌──────────────────────────────────────────────┐
│          マッチングシステム KPI                │
└──────────────────────────────────────────────┘

┌─────────────────┐  ┌─────────────────┐
│ マッチング精度   │  │   応募率         │
│                 │  │                 │
│     78%         │  │     10%         │
│   ↑ +8%        │  │   ↑ +2%        │
└─────────────────┘  └─────────────────┘

┌─────────────────┐  ┌─────────────────┐
│ ユーザー満足度   │  │ レスポンス時間   │
│                 │  │                 │
│   4.2 / 5.0     │  │    0.8秒        │
│   ↑ +0.3       │  │   ↓ -0.5秒     │
└─────────────────┘  └─────────────────┘

┌─────────────────────────────────────┐
│ データベースサイズ                    │
│                                     │
│ [████████░░] 80GB / 100GB (80%)     │
│ ↓ -20GB（最適化後）                 │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ クエリ実行時間（平均）                │
│                                     │
│ 最適化前: 2.5秒                      │
│ 最適化後: 0.3秒 ↓ 88%削減           │
└─────────────────────────────────────┘
```

---

# 🎯 まとめ：システム改善の重要ポイント

## 1. データ収集の充実
- ✅ ユーザーの行動を細かく追跡
- ✅ チャット履歴を蓄積
- ✅ 求人データを詳細に

## 2. マッチングアルゴリズムの多様化
- ✅ 協調フィルタリング
- ✅ コンテンツベースフィルタリング
- ✅ エンベディング検索
- ✅ 類似ユーザー検索

## 3. データベースの最適化
- ✅ インデックス追加
- ✅ データアーカイブ
- ✅ パーティショニング
- ✅ クエリ最適化

## 4. 継続的改善
- ✅ PDCAサイクル
- ✅ A/Bテスト
- ✅ ユーザーフィードバック
- ✅ KPIモニタリング

---

# 📚 関連ファイル

1. `SUMMARY.md` - 優先順位と期待効果
2. `rich_embedding_generator.py` - エンベディング改善
3. `improved_question_system.py` - 質問システム
4. `database_optimization.sql` - DB最適化SQL
5. `index_optimization.sql` - インデックス戦略
6. `query_optimization.sql` - クエリ最適化
7. `data_retention_policy.py` - データ保持ポリシー
8. `implementation_roadmap.py` - 実装計画

---

**🚀 このフローに従って段階的に実装すれば、マッチング率90%向上、クエリ速度10倍、ストレージ50%削減を達成できます！**
