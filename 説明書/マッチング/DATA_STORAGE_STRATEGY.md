# ğŸ”„ é€²åŒ–å‹AIã‚·ã‚¹ãƒ†ãƒ  - ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆ¦ç•¥å®Œå…¨ã‚¬ã‚¤ãƒ‰

---

## ğŸ“‹ ç›®æ¬¡

1. [ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å…¨ä½“åƒ](#1-ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å…¨ä½“åƒ)
2. [ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#2-ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
3. [æŸ”è»Ÿæ€§ã¨æ§‹é€ åŒ–ã®ãƒãƒ©ãƒ³ã‚¹](#3-æŸ”è»Ÿæ€§ã¨æ§‹é€ åŒ–ã®ãƒãƒ©ãƒ³ã‚¹)
4. [å®Ÿè£…ä¾‹](#4-å®Ÿè£…ä¾‹)

---

# 1. ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å…¨ä½“åƒ

## 1-1. ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•å±¥æ­´ã¨ã—ã¦ä¿å­˜ã•ã‚Œã‚‹ã‚‚ã®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ãƒ‡ãƒ¼ã‚¿ï¼ˆ5ã¤ã®ã‚«ãƒ†ã‚´ãƒªï¼‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€1. åŸºæœ¬çš„ãªè¡Œå‹•å±¥æ­´ã€‘
â”œâ”€ ã‚¯ãƒªãƒƒã‚¯ï¼ˆæ±‚äººã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰
â”œâ”€ é–²è¦§ï¼ˆæ±‚äººè©³ç´°ãƒšãƒ¼ã‚¸ã‚’è¦‹ãŸï¼‰
â”œâ”€ ãŠæ°—ã«å…¥ã‚Šï¼ˆæ±‚äººã‚’ä¿å­˜ï¼‰
â”œâ”€ å¿œå‹Ÿï¼ˆæ±‚äººã«å¿œå‹Ÿï¼‰
â””â”€ æ¤œç´¢ï¼ˆæ¡ä»¶ã§çµã‚Šè¾¼ã¿ï¼‰

ã€2. ãƒãƒ£ãƒƒãƒˆä¼šè©±å±¥æ­´ã€‘
â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ï¼ˆå…¨ãƒ†ã‚­ã‚¹ãƒˆï¼‰
â”œâ”€ AIã®è³ªå•ï¼ˆå…¨ãƒ†ã‚­ã‚¹ãƒˆï¼‰
â”œâ”€ ç™ºè¨€ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
â”œâ”€ ä¼šè©±ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
â””â”€ ä¼šè©±ã®ãƒˆãƒ”ãƒƒã‚¯

ã€3. æŠ½å‡ºã•ã‚ŒãŸæ§‹é€ åŒ–æƒ…å ±ã€‘
â”œâ”€ æ˜ç¤ºçš„ãªå¸Œæœ›æ¡ä»¶
â”‚  â”œâ”€ å¸Œæœ›è·ç¨®
â”‚  â”œâ”€ å¸Œæœ›å‹¤å‹™åœ°
â”‚  â”œâ”€ å¸Œæœ›å¹´å
â”‚  â””â”€ ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯å¸Œæœ›
â”‚
â”œâ”€ æš—é»™çš„ãªä¾¡å€¤è¦³
â”‚  â”œâ”€ ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹é‡è¦–åº¦
â”‚  â”œâ”€ ã‚­ãƒ£ãƒªã‚¢æˆé•·é‡è¦–åº¦
â”‚  â”œâ”€ å®‰å®šæ€§ vs æŒ‘æˆ¦
â”‚  â””â”€ ãƒãƒ¼ãƒ å¿—å‘ vs å€‹äººå¿—å‘
â”‚
â””â”€ æ„Ÿæƒ…ãƒ»æ…‹åº¦
   â”œâ”€ ãƒã‚¸ãƒ†ã‚£ãƒ–/ãƒã‚¬ãƒ†ã‚£ãƒ–
   â”œâ”€ ç¢ºä¿¡åº¦ï¼ˆè‡ªä¿¡ãŒã‚ã‚‹/è¿·ã£ã¦ã„ã‚‹ï¼‰
   â””â”€ ç·Šæ€¥åº¦ï¼ˆã™ãè»¢è·/ã˜ã£ãã‚Šæ¢ã™ï¼‰

ã€4. ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ãƒ™ã‚¯ãƒˆãƒ«ã€‘
â”œâ”€ ä¼šè©±å…¨ä½“ã®ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆ1536æ¬¡å…ƒï¼‰
â”œâ”€ å„ç™ºè¨€ã®ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°
â””â”€ æ™‚ç³»åˆ—ã§ã®ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°å¤‰åŒ–

ã€5. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€‘
â”œâ”€ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“
â”œâ”€ å¿œç­”é€Ÿåº¦
â”œâ”€ è³ªå•ã¸ã®å›ç­”ç‡
â”œâ”€ ä¼šè©±ã®æ·±ã•ãƒ¬ãƒ™ãƒ«
â””â”€ é›¢è„±ãƒã‚¤ãƒ³ãƒˆ
```

---

## 1-2. å…·ä½“ä¾‹ï¼š1äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®1å›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³

```
ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: 5001, ã‚»ãƒƒã‚·ãƒ§ãƒ³: session_abc123ã€‘

=== åŸºæœ¬çš„ãªè¡Œå‹•å±¥æ­´ ===
2025-12-22 14:30:00 | click    | job_001
2025-12-22 14:30:15 | view     | job_001
2025-12-22 14:31:00 | favorite | job_001
2025-12-22 14:35:00 | click    | job_002
2025-12-22 14:35:20 | view     | job_002

=== ãƒãƒ£ãƒƒãƒˆä¼šè©±å±¥æ­´ ===
[14:30:30] AI: ã€Œãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã«èˆˆå‘³ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€
[14:30:45] User: ã€Œã¯ã„ã€é€±3æ—¥ä»¥ä¸Šå¸Œæœ›ã—ã¾ã™ã€
[14:31:00] AI: ã€Œãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚’å¸Œæœ›ã™ã‚‹ç†ç”±ã‚’æ•™ãˆã¦ãã ã•ã„ã€
[14:31:30] User: ã€Œé€šå‹¤æ™‚é–“ãŒç‰‡é“1.5æ™‚é–“ã§ã€å®¶æ—ã¨ã®æ™‚é–“ã¨å‹‰å¼·ã«ä½¿ã„ãŸã„ã§ã™ã€
[14:32:00] AI: ã€Œä½•ã‚’å‹‰å¼·ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã‹ï¼Ÿã€
[14:32:20] User: ã€ŒReactã§ã™ã€‚å°†æ¥ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã«ãªã‚ŠãŸã„ã‹ã‚‰ã§ã™ã€

=== æŠ½å‡ºã•ã‚ŒãŸæ§‹é€ åŒ–æƒ…å ± ===
{
  "explicit_preferences": {
    "remote_work": "é€±3æ—¥ä»¥ä¸Š",
    "commute_time_current": "ç‰‡é“1.5æ™‚é–“",
    "learning_interest": "React",
    "career_goal": "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆ"
  },
  
  "implicit_values": {
    "work_life_balance_priority": 4,  // 5æ®µéšã§4
    "career_growth_priority": 5,      // 5æ®µéšã§5
    "family_priority": 5,              // ã€Œå®¶æ—ã¨ã®æ™‚é–“ã€ã‹ã‚‰æ¨å®š
    "learning_motivation": "high"      // ã€Œå‹‰å¼·ã—ãŸã„ã€ã‹ã‚‰æ¨å®š
  },
  
  "emotional_state": {
    "sentiment": "positive",           // å‰å‘ã
    "confidence": "high",              // ã€Œã€œã—ãŸã„ã€ã¨æ˜ç¢º
    "urgency": "medium"                // æ€¥ã„ã§ã„ãªã„æ§˜å­
  },
  
  "behavioral_pattern": {
    "response_time_avg": 25,           // å¹³å‡25ç§’ã§å›ç­”
    "response_length_avg": 45,         // å¹³å‡45æ–‡å­—
    "engagement_level": "high"         // ã‚ˆãè©±ã—ã¦ãã‚Œã‚‹
  }
}

=== ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ãƒ™ã‚¯ãƒˆãƒ« ===
conversation_embedding: [0.123, -0.456, 0.789, ...] (1536æ¬¡å…ƒ)

=== ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ===
session_duration: 5åˆ†30ç§’
total_exchanges: 3å¾€å¾©
conversation_depth: 3 (æ·±æ˜ã‚Šè³ªå•ã¾ã§åˆ°é”)
completion_status: "in_progress"
```

---

# 2. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

## 2-1. ãªãœãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹ãªã®ã‹ï¼Ÿ

```
âŒ å®Œå…¨å›ºå®šã‚«ãƒ©ãƒ å‹ã®å•é¡Œ:
- æ–°ã—ã„è³ªå•ã«å¯¾å¿œã§ããªã„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¤šæ§˜ãªå›ç­”ã‚’ä¿å­˜ã§ããªã„
- æŸ”è»Ÿæ€§ãŒãªã„

âŒ å®Œå…¨ãƒ•ãƒªãƒ¼ãƒ•ã‚©ãƒ¼ãƒ å‹ã®å•é¡Œ:
- ã‚¯ã‚¨ãƒªãŒé…ã„
- é›†è¨ˆãƒ»åˆ†æãŒå›°é›£
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ã‹ãªã„

âœ… ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹ã®åˆ©ç‚¹:
- ã‚ˆãä½¿ã†æƒ…å ±ã¯å›ºå®šã‚«ãƒ©ãƒ ï¼ˆé«˜é€Ÿï¼‰
- æŸ”è»Ÿãªæƒ…å ±ã¯JSON/ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ‹¡å¼µæ€§ï¼‰
- ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ã§æ„å‘³æ¤œç´¢ï¼ˆAIæ´»ç”¨ï¼‰
```

---

## 2-2. ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆï¼ˆå®Œå…¨ç‰ˆï¼‰

### A. æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå›ºå®šã‚«ãƒ©ãƒ ï¼‰

```sql
-- ============================================
-- user_profile ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆåŸºæœ¬æƒ…å ±ï¼‰
-- ============================================
CREATE TABLE user_profile (
    user_id INTEGER PRIMARY KEY,
    
    -- åŸºæœ¬å¸Œæœ›æ¡ä»¶ï¼ˆå›ºå®šã‚«ãƒ©ãƒ  - ã‚ˆãä½¿ã†ã®ã§é«˜é€ŸåŒ–ï¼‰
    job_title VARCHAR(100),              -- å¸Œæœ›è·ç¨®
    location_prefecture VARCHAR(50),     -- å¸Œæœ›å‹¤å‹™åœ°
    salary_min INTEGER,                  -- å¸Œæœ›æœ€ä½å¹´å
    
    -- å„ªå…ˆåº¦ï¼ˆ1-5ã‚¹ã‚±ãƒ¼ãƒ« - é›†è¨ˆã—ã‚„ã™ã„ï¼‰
    work_life_balance_priority INTEGER DEFAULT 3,
    salary_priority INTEGER DEFAULT 3,
    career_growth_priority INTEGER DEFAULT 3,
    stability_priority INTEGER DEFAULT 3,
    
    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰¹æ€§ï¼ˆã‚«ãƒ†ã‚´ãƒªã‚«ãƒ« - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é«˜é€Ÿï¼‰
    decision_style VARCHAR(50),          -- 'quick', 'cautious', 'analytical'
    career_stage VARCHAR(50),            -- 'junior', 'mid', 'senior'
    
    -- ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼‰
    conversation_embedding VECTOR(1536), -- pgvectorå‹
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    profile_completeness INTEGER DEFAULT 0,
    last_updated TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé«˜é€Ÿæ¤œç´¢ç”¨ï¼‰
CREATE INDEX idx_user_profile_job ON user_profile(job_title);
CREATE INDEX idx_user_profile_location ON user_profile(location_prefecture);
CREATE INDEX idx_user_profile_salary ON user_profile(salary_min);
CREATE INDEX idx_user_profile_embedding ON user_profile 
    USING ivfflat (conversation_embedding vector_cosine_ops);
```

---

### B. æŸ”è»Ÿãªéæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆJSONBï¼‰

```sql
-- ============================================
-- user_dynamic_profile ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæŸ”è»Ÿãªæƒ…å ±ï¼‰
-- ============================================
CREATE TABLE user_dynamic_profile (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES user_profile(user_id),
    
    -- ğŸŒŸ ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼šJSONBã§æŸ”è»Ÿã«ä¿å­˜
    profile_data JSONB NOT NULL,
    
    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    data_version INTEGER DEFAULT 1,  -- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- åˆ¶ç´„ï¼š1ãƒ¦ãƒ¼ã‚¶ãƒ¼1ãƒ¬ã‚³ãƒ¼ãƒ‰
    UNIQUE(user_id)
);

-- JSONBç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé‡è¦ï¼ï¼‰
CREATE INDEX idx_dynamic_profile_data ON user_dynamic_profile USING GIN (profile_data);

-- ç‰¹å®šã®JSONã‚­ãƒ¼ã¸ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã•ã‚‰ã«é«˜é€ŸåŒ–ï¼‰
CREATE INDEX idx_dynamic_profile_career_goal 
    ON user_dynamic_profile ((profile_data->>'career_goal'));
CREATE INDEX idx_dynamic_profile_learning_interests 
    ON user_dynamic_profile ((profile_data->'learning_interests'));
```

**JSONBã«ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ä¾‹ï¼š**

```json
{
  "career_goal": "3å¹´å¾Œã¯ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰ã«ãªã‚ŠãŸã„",
  "learning_interests": ["React", "TypeScript", "AWS"],
  "current_skills": ["HTML", "CSS", "JavaScript", "Python"],
  "years_experience": 5,
  
  "pain_points": [
    "å‰è·ã¯æ®‹æ¥­ãŒå¤šã‹ã£ãŸ",
    "æŠ€è¡“çš„ãªæŒ‘æˆ¦ãŒå°‘ãªã‹ã£ãŸ",
    "ã‚­ãƒ£ãƒªã‚¢ãƒ‘ã‚¹ãŒä¸æ˜ç¢ºã ã£ãŸ"
  ],
  
  "enjoyed_aspects": [
    "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒè‰¯ã‹ã£ãŸ",
    "è‡ªç¤¾ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚ŒãŸ"
  ],
  
  "work_style_preferences": {
    "team_size": "5-10äººãŒç†æƒ³",
    "meeting_frequency": "é€±2-3å›ãŒé©åˆ‡",
    "communication_style": "Slackä¸­å¿ƒã€å¯¾é¢ã¯é€±1å›"
  },
  
  "company_preferences": {
    "size": "50-300äººã®ãƒŸãƒ‰ãƒ«ãƒ™ãƒ³ãƒãƒ£ãƒ¼",
    "culture": "ãƒ•ãƒ©ãƒƒãƒˆãªçµ„ç¹”ã€æŠ€è¡“é‡è¦–",
    "industry": ["Web", "SaaS", "AI"]
  },
  
  "avoiding": {
    "industries": ["é‡‘è", "å—è¨—"],
    "company_types": ["å¤§ä¼æ¥­ã®å­ä¼šç¤¾"],
    "work_environments": ["é•·æ™‚é–“åŠ´åƒãŒå½“ãŸã‚Šå‰"]
  },
  
  "custom_fields": {
    "favorite_tech_blog": "Qiita",
    "conference_attendance": "å¹´2-3å›",
    "side_projects": "å€‹äººã§Reactã‚¢ãƒ—ãƒªé–‹ç™ºä¸­"
  }
}
```

---

### C. ãƒãƒ£ãƒƒãƒˆä¼šè©±å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå®Œå…¨ãƒ†ã‚­ã‚¹ãƒˆï¼‰

```sql
-- ============================================
-- chat_history ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¼šè©±ã®ç”Ÿãƒ­ã‚°ï¼‰
-- ============================================
CREATE TABLE chat_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES user_profile(user_id),
    session_id VARCHAR(255) NOT NULL,
    
    -- ä¼šè©±ã®ç™ºè¨€è€…ã¨å†…å®¹
    sender VARCHAR(50) NOT NULL,  -- 'user' or 'bot'
    message TEXT NOT NULL,        -- ğŸŒŸ å®Œå…¨ãªãƒ†ã‚­ã‚¹ãƒˆä¿å­˜
    
    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_chat_history_user_session 
    ON chat_history(user_id, session_id);
CREATE INDEX idx_chat_history_created 
    ON chat_history(created_at DESC);

-- å…¨æ–‡æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆPostgreSQLï¼‰
CREATE INDEX idx_chat_message_fulltext 
    ON chat_history USING GIN (to_tsvector('japanese', message));
```

---

### D. æŠ½å‡ºæ¸ˆã¿æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆAIãŒæ§‹é€ åŒ–ï¼‰

```sql
-- ============================================
-- extracted_insights ãƒ†ãƒ¼ãƒ–ãƒ«
-- AIãŒä¼šè©±ã‹ã‚‰æŠ½å‡ºã—ãŸæ§‹é€ åŒ–æƒ…å ±
-- ============================================
CREATE TABLE extracted_insights (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES user_profile(user_id),
    session_id VARCHAR(255),
    
    -- æŠ½å‡ºå…ƒã®æƒ…å ±
    source_message_id INTEGER REFERENCES chat_history(id),
    extraction_timestamp TIMESTAMP DEFAULT NOW(),
    
    -- æŠ½å‡ºã•ã‚ŒãŸæƒ…å ±ï¼ˆJSONBï¼‰
    insights JSONB NOT NULL,
    
    -- ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ï¼ˆAIã®ç¢ºä¿¡åº¦ï¼‰
    confidence_score DECIMAL(3,2),  -- 0.00 - 1.00
    
    -- ã©ã®AIãƒ¢ãƒ‡ãƒ«ãŒæŠ½å‡ºã—ãŸã‹
    extracted_by VARCHAR(50) DEFAULT 'gpt-4',
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_extracted_insights_user 
    ON extracted_insights(user_id);
CREATE INDEX idx_extracted_insights_data 
    ON extracted_insights USING GIN (insights);
```

**æŠ½å‡ºæ¸ˆã¿æƒ…å ±ã®ä¾‹ï¼š**

```json
{
  "extraction_type": "career_preference",
  "extracted_at": "2025-12-22T14:32:20Z",
  
  "raw_message": "Reactã§ã™ã€‚å°†æ¥ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã«ãªã‚ŠãŸã„ã‹ã‚‰ã§ã™",
  
  "structured_data": {
    "learning_interest": "React",
    "career_goal": "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆ",
    "motivation": "career_advancement",
    "urgency": "long_term"
  },
  
  "inferred_values": {
    "career_growth_priority": 5,
    "learning_motivation": "high",
    "technical_focus": true
  },
  
  "keywords": ["React", "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰", "ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆ", "å‹‰å¼·"],
  
  "sentiment": {
    "polarity": "positive",
    "confidence": 0.92
  }
}
```

---

### E. ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ™‚ç³»åˆ—ï¼‰

```sql
-- ============================================
-- user_embedding_history ãƒ†ãƒ¼ãƒ–ãƒ«
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èˆˆå‘³ãƒ»å¸Œæœ›ã®å¤‰åŒ–ã‚’è¿½è·¡
-- ============================================
CREATE TABLE user_embedding_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES user_profile(user_id),
    session_id VARCHAR(255),
    
    -- ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ãƒ™ã‚¯ãƒˆãƒ«
    embedding VECTOR(1536) NOT NULL,
    
    -- ä½•ã«åŸºã¥ãã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ã‹
    source_type VARCHAR(50),  -- 'conversation', 'behavior', 'hybrid'
    source_text TEXT,         -- ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ
    
    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_embedding_history_user 
    ON user_embedding_history(user_id, created_at DESC);
CREATE INDEX idx_embedding_history_vector 
    ON user_embedding_history USING ivfflat (embedding vector_cosine_ops);
```

---

## 2-3. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡                 â”‚
â”‚    ã€Œé€šå‹¤1.5æ™‚é–“ã€‚å®¶æ—æ™‚é–“ã¨Reactå‹‰å¼·ã«ä½¿ã„ãŸã„ã€â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: ç”Ÿãƒ­ã‚°ä¿å­˜ï¼ˆå®Œå…¨ãƒ†ã‚­ã‚¹ãƒˆï¼‰             â”‚
â”‚                                              â”‚
â”‚ INSERT INTO chat_history (                   â”‚
â”‚   user_id, session_id, sender, message       â”‚
â”‚ ) VALUES (                                   â”‚
â”‚   5001, 'session_abc', 'user',               â”‚
â”‚   'é€šå‹¤1.5æ™‚é–“ã€‚å®¶æ—æ™‚é–“ã¨Reactå‹‰å¼·ã«...'      â”‚
â”‚ )                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: AIåˆ†æï¼ˆOpenAI APIã§æƒ…å ±æŠ½å‡ºï¼‰        â”‚
â”‚                                              â”‚
â”‚ response = openai.chat.completions.create(   â”‚
â”‚   model="gpt-4",                             â”‚
â”‚   messages=[{                                â”‚
â”‚     "role": "system",                        â”‚
â”‚     "content": "ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡º:\           â”‚
â”‚                 1. æ˜ç¤ºçš„ãªå¸Œæœ›æ¡ä»¶\         â”‚
â”‚                 2. æš—é»™ã®ä¾¡å€¤è¦³\            â”‚
â”‚                 3. æ„Ÿæƒ…ãƒ»æ…‹åº¦"              â”‚
â”‚   }, {                                       â”‚
â”‚     "role": "user",                          â”‚
â”‚     "content": "é€šå‹¤1.5æ™‚é–“ã€‚å®¶æ—..."        â”‚
â”‚   }]                                         â”‚
â”‚ )                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: æŠ½å‡ºã•ã‚ŒãŸæƒ…å ±ã‚’ä¿å­˜                  â”‚
â”‚                                              â”‚
â”‚ A) æ§‹é€ åŒ–æƒ…å ±ï¼ˆextracted_insightsï¼‰          â”‚
â”‚ {                                            â”‚
â”‚   "commute_time": "ç‰‡é“1.5æ™‚é–“",            â”‚
â”‚   "pain_point": "é€šå‹¤æ™‚é–“ãŒé•·ã„",           â”‚
â”‚   "learning_interest": "React",             â”‚
â”‚   "priority": "å®¶æ—æ™‚é–“",                   â”‚
â”‚   "career_goal": "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‹‰å¼·"        â”‚
â”‚ }                                            â”‚
â”‚                                              â”‚
â”‚ B) å›ºå®šã‚«ãƒ©ãƒ æ›´æ–°ï¼ˆuser_profileï¼‰            â”‚
â”‚ UPDATE user_profile SET                      â”‚
â”‚   work_life_balance_priority = 5,           â”‚
â”‚   career_growth_priority = 5                â”‚
â”‚ WHERE user_id = 5001                         â”‚
â”‚                                              â”‚
â”‚ C) æŸ”è»Ÿãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆuser_dynamic_profileï¼‰     â”‚
â”‚ UPDATE user_dynamic_profile SET              â”‚
â”‚   profile_data = jsonb_set(                  â”‚
â”‚     profile_data,                            â”‚
â”‚     '{learning_interests}',                  â”‚
â”‚     '["React"]'                              â”‚
â”‚   )                                          â”‚
â”‚ WHERE user_id = 5001                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆï¼†ä¿å­˜              â”‚
â”‚                                              â”‚
â”‚ embedding = openai.embeddings.create(        â”‚
â”‚   model="text-embedding-3-small",            â”‚
â”‚   input="é€šå‹¤1.5æ™‚é–“ã€‚å®¶æ—æ™‚é–“ã¨Reactå‹‰å¼·..."  â”‚
â”‚ )                                            â”‚
â”‚                                              â”‚
â”‚ INSERT INTO user_embedding_history (         â”‚
â”‚   user_id, embedding, source_text            â”‚
â”‚ ) VALUES (                                   â”‚
â”‚   5001, embedding, "é€šå‹¤1.5æ™‚é–“..."          â”‚
â”‚ )                                            â”‚
â”‚                                              â”‚
â”‚ UPDATE user_profile SET                      â”‚
â”‚   conversation_embedding = embedding         â”‚
â”‚ WHERE user_id = 5001                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# 3. æŸ”è»Ÿæ€§ã¨æ§‹é€ åŒ–ã®ãƒãƒ©ãƒ³ã‚¹

## 3-1. è¨­è¨ˆå“²å­¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   80/20ãƒ«ãƒ¼ãƒ«                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€80%ã®ã‚±ãƒ¼ã‚¹ã€‘å›ºå®šã‚«ãƒ©ãƒ ã§å¯¾å¿œ
- job_title
- location_prefecture
- salary_min
- work_life_balance_priority
- career_growth_priority

â†’ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒåŠ¹ãã€ã‚¯ã‚¨ãƒªé«˜é€Ÿã€é›†è¨ˆç°¡å˜

ã€20%ã®ã‚±ãƒ¼ã‚¹ã€‘JSONBã§å¯¾å¿œ
- äºˆæƒ³å¤–ã®è³ªå•
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç‹¬è‡ªã®ä¾¡å€¤è¦³
- æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒª

â†’ æŸ”è»Ÿæ€§ã€æ‹¡å¼µæ€§

ã€ã™ã¹ã¦ã®ã‚±ãƒ¼ã‚¹ã€‘ãƒ†ã‚­ã‚¹ãƒˆ+ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ã§å¯¾å¿œ
- å®Œå…¨ãªä¼šè©±å±¥æ­´ã‚’ä¿å­˜
- ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ã§æ„å‘³æ¤œç´¢
- AIãŒå¿…è¦ã«å¿œã˜ã¦å†è§£æ
```

---

## 3-2. ã‚¯ã‚¨ãƒªä¾‹ï¼š3ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1: å›ºå®šã‚«ãƒ©ãƒ ï¼ˆé«˜é€Ÿï¼‰

```sql
-- ã€Œãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯é‡è¦–ã€ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
SELECT user_id, job_title, location_prefecture
FROM user_profile
WHERE work_life_balance_priority >= 4  -- å›ºå®šã‚«ãƒ©ãƒ 
  AND salary_min >= 500
ORDER BY work_life_balance_priority DESC
LIMIT 10;

-- å®Ÿè¡Œæ™‚é–“: 10msï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ï¼‰
```

---

### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2: JSONBï¼ˆæŸ”è»Ÿï¼‰

```sql
-- ã€ŒReactã‚’å­¦ã³ãŸã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
SELECT 
    up.user_id,
    up.job_title,
    udp.profile_data->'learning_interests' as interests
FROM user_profile up
JOIN user_dynamic_profile udp ON up.user_id = udp.user_id
WHERE udp.profile_data->'learning_interests' ? 'React'  -- JSONBæ¤œç´¢
  AND udp.profile_data->>'career_goal' LIKE '%ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰%'
LIMIT 10;

-- å®Ÿè¡Œæ™‚é–“: 50msï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ï¼‰
```

---

### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3: ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆæ„å‘³æ¤œç´¢ï¼‰

```sql
-- ã€Œãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹ã‚’é‡è¦–ã—ã€æŠ€è¡“çš„æˆé•·ã‚‚æ±‚ã‚ã‚‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
-- ï¼ˆå›ºå®šã‚«ãƒ©ãƒ ã«ãªã„è¤‡é›‘ãªæ¡ä»¶ï¼‰

WITH query_embedding AS (
    -- ã‚¯ã‚¨ãƒªã®ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ã‚’å–å¾—ï¼ˆäº‹å‰ã«Pythonã§ç”Ÿæˆï¼‰
    SELECT '[0.123, -0.456, ...]'::vector as embedding
)
SELECT 
    up.user_id,
    up.job_title,
    1 - (up.conversation_embedding <=> qe.embedding) as similarity
FROM user_profile up, query_embedding qe
WHERE up.conversation_embedding IS NOT NULL
ORDER BY up.conversation_embedding <=> qe.embedding
LIMIT 10;

-- å®Ÿè¡Œæ™‚é–“: 100msï¼ˆãƒ™ã‚¯ãƒˆãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ï¼‰
```

---

## 3-3. æ–°ã—ã„è³ªå•ã¸ã®å¯¾å¿œãƒ•ãƒ­ãƒ¼

```
ã€ã‚·ãƒŠãƒªã‚ªã€‘
æ–°ã—ãã€Œå‰¯æ¥­ã®å¯å¦ã€ã«ã¤ã„ã¦èãã“ã¨ã«ã—ãŸ

å¾“æ¥ã®å›ºå®šã‚«ãƒ©ãƒ å‹:
âŒ ALTER TABLE ã§æ–°ã‚«ãƒ©ãƒ è¿½åŠ ãŒå¿…è¦
âŒ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯NULL
âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦

ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹:
âœ… ä½•ã‚‚ã—ãªãã¦OKï¼

ãƒ•ãƒ­ãƒ¼:
1. AIãŒã€Œå‰¯æ¥­ã«ã¤ã„ã¦å¸Œæœ›ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€ã¨è³ªå•
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œå‰¯æ¥­ã‚‚ã‚„ã‚ŠãŸã„ã§ã™ã€ã¨å›ç­”
3. chat_history ã«ä¿å­˜ï¼ˆå®Œå…¨ãƒ†ã‚­ã‚¹ãƒˆï¼‰
4. AIãŒæƒ…å ±æŠ½å‡º:
   {
     "side_job_preference": "å¸Œæœ›ã™ã‚‹",
     "side_job_motivation": "åå…¥å¢—ã€ã‚¹ã‚­ãƒ«å‘ä¸Š"
   }
5. user_dynamic_profile ã® JSONB ã«è¿½åŠ :
   UPDATE user_dynamic_profile
   SET profile_data = jsonb_set(
       profile_data,
       '{side_job_preference}',
       '"å¸Œæœ›ã™ã‚‹"'
   )

â†’ ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ä¸è¦ï¼
â†’ æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ å½±éŸ¿ãªã—ï¼
â†’ å³åº§ã«æ¤œç´¢å¯èƒ½ï¼
```

---

## 3-4. å®Ÿéš›ã®ã‚¯ã‚¨ãƒªä¾‹ï¼šè¤‡é›‘ãªæ¡ä»¶

```python
def find_matching_users(complex_criteria):
    """
    è¤‡é›‘ãªæ¡ä»¶ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
    å›ºå®šã‚«ãƒ©ãƒ  + JSONB + ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚° ã®çµ„ã¿åˆã‚ã›
    """
    
    conn = get_db_conn()
    cur = conn.cursor()
    
    # ã‚¯ã‚¨ãƒªã®ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆ
    query_text = f"""
    {complex_criteria['description']}
    è·ç¨®: {complex_criteria.get('job_title')}
    å„ªå…ˆäº‹é …: {complex_criteria.get('priorities')}
    """
    
    query_embedding = generate_embedding(query_text)
    
    # è¤‡åˆã‚¯ã‚¨ãƒª
    cur.execute("""
        SELECT 
            up.user_id,
            up.job_title,
            up.location_prefecture,
            udp.profile_data->'learning_interests' as learning,
            1 - (up.conversation_embedding <=> %s::vector) as similarity
        FROM user_profile up
        JOIN user_dynamic_profile udp ON up.user_id = udp.user_id
        WHERE 
            -- å›ºå®šã‚«ãƒ©ãƒ ã§é«˜é€Ÿãƒ•ã‚£ãƒ«ã‚¿
            up.work_life_balance_priority >= %s
            AND up.salary_min >= %s
            
            -- JSONBã§æŸ”è»Ÿãƒ•ã‚£ãƒ«ã‚¿
            AND udp.profile_data->'learning_interests' ? %s
            
            -- ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ã§æ„å‘³çš„é¡ä¼¼åº¦
            AND (up.conversation_embedding <=> %s::vector) < 0.3
            
        ORDER BY similarity DESC
        LIMIT 20
    """, (
        query_embedding,
        complex_criteria['min_wlb_priority'],
        complex_criteria['min_salary'],
        complex_criteria['required_skill'],
        query_embedding
    ))
    
    return cur.fetchall()


# ä½¿ç”¨ä¾‹
results = find_matching_users({
    'description': 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æŠ€è¡“ã‚’å­¦ã³ãŸã„ã€å®¶æ—æ™‚é–“ã‚‚å¤§åˆ‡ã«ã—ãŸã„',
    'job_title': 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
    'priorities': ['work_life_balance', 'career_growth'],
    'min_wlb_priority': 4,
    'min_salary': 500,
    'required_skill': 'React'
})
```

---

# 4. å®Ÿè£…ä¾‹

## 4-1. ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã®å®Œå…¨ãªæµã‚Œ

```python
"""
user_profile_manager.py
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ãƒ»æ›´æ–°ã‚’ç®¡ç†
"""

import json
from openai import OpenAI
import psycopg2

client = OpenAI()

class UserProfileManager:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†
    å›ºå®šã‚«ãƒ©ãƒ ã€JSONBã€ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ã‚’é©åˆ‡ã«ä½¿ã„åˆ†ã‘
    """
    
    def __init__(self, user_id):
        self.user_id = user_id
        self.conn = psycopg2.connect(
            host="localhost",
            dbname="jobmatch",
            user="devuser",
            password="devpass"
        )
    
    def save_chat_message(self, session_id, sender, message):
        """
        ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜ï¼ˆå®Œå…¨ãƒ†ã‚­ã‚¹ãƒˆï¼‰
        """
        cur = self.conn.cursor()
        
        cur.execute("""
            INSERT INTO chat_history (
                user_id, session_id, sender, message, created_at
            ) VALUES (%s, %s, %s, %s, NOW())
            RETURNING id
        """, (self.user_id, session_id, sender, message))
        
        message_id = cur.fetchone()[0]
        self.conn.commit()
        cur.close()
        
        return message_id
    
    def extract_and_save_insights(self, message, message_id):
        """
        AIã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ä¿å­˜
        """
        
        # STEP 1: AIã§æƒ…å ±æŠ½å‡º
        extracted = self._extract_insights_with_ai(message)
        
        if not extracted:
            return
        
        cur = self.conn.cursor()
        
        # STEP 2: æŠ½å‡ºæƒ…å ±ã‚’extracted_insightsã«ä¿å­˜
        cur.execute("""
            INSERT INTO extracted_insights (
                user_id, source_message_id, insights, 
                confidence_score, created_at
            ) VALUES (%s, %s, %s, %s, NOW())
        """, (
            self.user_id,
            message_id,
            json.dumps(extracted),
            extracted.get('confidence', 0.8)
        ))
        
        # STEP 3: å›ºå®šã‚«ãƒ©ãƒ ã‚’æ›´æ–°ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
        self._update_fixed_columns(extracted)
        
        # STEP 4: JSONBã‚’æ›´æ–°ï¼ˆæŸ”è»Ÿãƒ‡ãƒ¼ã‚¿ï¼‰
        self._update_dynamic_profile(extracted)
        
        self.conn.commit()
        cur.close()
    
    def _extract_insights_with_ai(self, message):
        """
        OpenAI APIã§æƒ…å ±ã‚’æŠ½å‡º
        """
        
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {
                    "role": "system",
                    "content": """
ã‚ãªãŸã¯æ±‚äººãƒãƒƒãƒãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã¦JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„:

1. explicit_preferences: æ˜ç¤ºçš„ãªå¸Œæœ›æ¡ä»¶
   - job_title, location, salary, remote_work ãªã©

2. implicit_values: æš—é»™ã®ä¾¡å€¤è¦³ï¼ˆ1-5ã§æ¨å®šï¼‰
   - work_life_balance_priority
   - career_growth_priority
   - stability_priority

3. emotional_state: æ„Ÿæƒ…ãƒ»æ…‹åº¦
   - sentiment (positive/negative/neutral)
   - confidence (high/medium/low)
   - urgency (high/medium/low)

4. extracted_keywords: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º

5. confidence: ã“ã®æŠ½å‡ºã®ä¿¡é ¼åº¦ (0.0-1.0)

JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚
"""
                },
                {
                    "role": "user",
                    "content": message
                }
            ],
            temperature=0.3,
            response_format={ "type": "json_object" }
        )
        
        try:
            return json.loads(response.choices[0].message.content)
        except:
            return None
    
    def _update_fixed_columns(self, extracted):
        """
        å›ºå®šã‚«ãƒ©ãƒ ã‚’æ›´æ–°
        """
        cur = self.conn.cursor()
        
        # å„ªå…ˆåº¦ã®æ›´æ–°
        implicit_values = extracted.get('implicit_values', {})
        
        if implicit_values:
            cur.execute("""
                UPDATE user_profile
                SET 
                    work_life_balance_priority = COALESCE(%s, work_life_balance_priority),
                    career_growth_priority = COALESCE(%s, career_growth_priority),
                    stability_priority = COALESCE(%s, stability_priority),
                    last_updated = NOW()
                WHERE user_id = %s
            """, (
                implicit_values.get('work_life_balance_priority'),
                implicit_values.get('career_growth_priority'),
                implicit_values.get('stability_priority'),
                self.user_id
            ))
        
        # åŸºæœ¬æƒ…å ±ã®æ›´æ–°
        explicit_prefs = extracted.get('explicit_preferences', {})
        
        if explicit_prefs:
            cur.execute("""
                UPDATE user_profile
                SET 
                    job_title = COALESCE(%s, job_title),
                    location_prefecture = COALESCE(%s, location_prefecture),
                    salary_min = COALESCE(%s, salary_min)
                WHERE user_id = %s
            """, (
                explicit_prefs.get('job_title'),
                explicit_prefs.get('location'),
                explicit_prefs.get('salary_min'),
                self.user_id
            ))
        
        cur.close()
    
    def _update_dynamic_profile(self, extracted):
        """
        JSONBï¼ˆæŸ”è»Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’æ›´æ–°
        """
        cur = self.conn.cursor()
        
        # æ—¢å­˜ã®JSONBãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        cur.execute("""
            SELECT profile_data 
            FROM user_dynamic_profile 
            WHERE user_id = %s
        """, (self.user_id,))
        
        result = cur.fetchone()
        current_data = result[0] if result else {}
        
        # æ–°ã—ã„æƒ…å ±ã‚’ãƒãƒ¼ã‚¸
        explicit_prefs = extracted.get('explicit_preferences', {})
        keywords = extracted.get('extracted_keywords', [])
        
        # learning_interests ã®è¿½åŠ 
        if 'learning_interest' in explicit_prefs:
            if 'learning_interests' not in current_data:
                current_data['learning_interests'] = []
            
            interest = explicit_prefs['learning_interest']
            if interest not in current_data['learning_interests']:
                current_data['learning_interests'].append(interest)
        
        # career_goal ã®æ›´æ–°
        if 'career_goal' in explicit_prefs:
            current_data['career_goal'] = explicit_prefs['career_goal']
        
        # pain_points ã®è¿½åŠ 
        if 'pain_point' in explicit_prefs:
            if 'pain_points' not in current_data:
                current_data['pain_points'] = []
            current_data['pain_points'].append(explicit_prefs['pain_point'])
        
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®è“„ç©
        if 'all_keywords' not in current_data:
            current_data['all_keywords'] = []
        current_data['all_keywords'].extend(keywords)
        current_data['all_keywords'] = list(set(current_data['all_keywords']))  # é‡è¤‡å‰Šé™¤
        
        # JSONBã‚’æ›´æ–°
        cur.execute("""
            INSERT INTO user_dynamic_profile (user_id, profile_data)
            VALUES (%s, %s)
            ON CONFLICT (user_id) DO UPDATE
            SET profile_data = %s,
                updated_at = NOW()
        """, (
            self.user_id,
            json.dumps(current_data),
            json.dumps(current_data)
        ))
        
        cur.close()
    
    def update_conversation_embedding(self, session_id):
        """
        ä¼šè©±ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç”Ÿæˆï¼†æ›´æ–°
        """
        cur = self.conn.cursor()
        
        # æœ€è¿‘ã®ä¼šè©±ã‚’å–å¾—
        cur.execute("""
            SELECT message
            FROM chat_history
            WHERE user_id = %s
              AND session_id = %s
              AND sender = 'user'
            ORDER BY created_at DESC
            LIMIT 10
        """, (self.user_id, session_id))
        
        messages = [row[0] for row in cur.fetchall()]
        
        if not messages:
            cur.close()
            return
        
        # ä¼šè©±ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
        conversation_text = "\n".join(reversed(messages))
        
        # ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ç”Ÿæˆ
        response = client.embeddings.create(
            model="text-embedding-3-small",
            input=conversation_text
        )
        
        embedding = response.data[0].embedding
        
        # ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°å±¥æ­´ã«ä¿å­˜
        cur.execute("""
            INSERT INTO user_embedding_history (
                user_id, session_id, embedding, 
                source_type, source_text, created_at
            ) VALUES (%s, %s, %s, %s, %s, NOW())
        """, (
            self.user_id,
            session_id,
            embedding,
            'conversation',
            conversation_text[:500]  # æœ€åˆã®500æ–‡å­—
        ))
        
        # user_profile ã®ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ›´æ–°
        cur.execute("""
            UPDATE user_profile
            SET conversation_embedding = %s::vector,
                last_updated = NOW()
            WHERE user_id = %s
        """, (embedding, self.user_id))
        
        self.conn.commit()
        cur.close()
    
    def close(self):
        self.conn.close()


# ============================================
# ä½¿ç”¨ä¾‹
# ============================================

def handle_user_message(user_id, session_id, message):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ãã®å‡¦ç†
    """
    
    manager = UserProfileManager(user_id)
    
    # 1. ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
    message_id = manager.save_chat_message(
        session_id=session_id,
        sender='user',
        message=message
    )
    
    # 2. AIã§æƒ…å ±æŠ½å‡ºï¼†ä¿å­˜
    manager.extract_and_save_insights(message, message_id)
    
    # 3. ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°æ›´æ–°
    manager.update_conversation_embedding(session_id)
    
    manager.close()
    
    print(f"""
    âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã—ã¾ã—ãŸ
    
    ä¿å­˜å…ˆ:
    - chat_history: å®Œå…¨ãƒ†ã‚­ã‚¹ãƒˆ
    - extracted_insights: AIæŠ½å‡ºæƒ…å ±
    - user_profile: å›ºå®šã‚«ãƒ©ãƒ æ›´æ–°
    - user_dynamic_profile: JSONBæ›´æ–°
    - user_embedding_history: ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°
    """)


# å®Ÿè¡Œä¾‹
if __name__ == "__main__":
    handle_user_message(
        user_id=5001,
        session_id="session_abc123",
        message="é€šå‹¤æ™‚é–“ãŒç‰‡é“1.5æ™‚é–“ã§ã€å®¶æ—ã¨ã®æ™‚é–“ã¨Reactã®å‹‰å¼·ã«ä½¿ã„ãŸã„ã§ã™"
    )
```

---

## 4-2. ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ä¾‹

```python
def get_comprehensive_user_profile(user_id):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒ…æ‹¬çš„ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    å›ºå®šã‚«ãƒ©ãƒ  + JSONB + ä¼šè©±å±¥æ­´ + ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°
    """
    
    conn = get_db_conn()
    cur = conn.cursor()
    
    # 1. å›ºå®šã‚«ãƒ©ãƒ ãƒ‡ãƒ¼ã‚¿
    cur.execute("""
        SELECT 
            job_title,
            location_prefecture,
            salary_min,
            work_life_balance_priority,
            career_growth_priority,
            decision_style,
            career_stage
        FROM user_profile
        WHERE user_id = %s
    """, (user_id,))
    
    fixed_data = cur.fetchone()
    
    # 2. JSONBæŸ”è»Ÿãƒ‡ãƒ¼ã‚¿
    cur.execute("""
        SELECT profile_data
        FROM user_dynamic_profile
        WHERE user_id = %s
    """, (user_id,))
    
    dynamic_data = cur.fetchone()
    dynamic_profile = dynamic_data[0] if dynamic_data else {}
    
    # 3. æœ€è¿‘ã®ä¼šè©±å±¥æ­´
    cur.execute("""
        SELECT sender, message, created_at
        FROM chat_history
        WHERE user_id = %s
        ORDER BY created_at DESC
        LIMIT 20
    """, (user_id,))
    
    chat_history = cur.fetchall()
    
    # 4. æŠ½å‡ºæ¸ˆã¿ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
    cur.execute("""
        SELECT insights, confidence_score, created_at
        FROM extracted_insights
        WHERE user_id = %s
        ORDER BY created_at DESC
        LIMIT 10
    """, (user_id,))
    
    insights = cur.fetchall()
    
    cur.close()
    conn.close()
    
    # çµ±åˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
    return {
        'basic_info': {
            'job_title': fixed_data[0],
            'location': fixed_data[1],
            'salary_min': fixed_data[2]
        },
        'priorities': {
            'work_life_balance': fixed_data[3],
            'career_growth': fixed_data[4]
        },
        'characteristics': {
            'decision_style': fixed_data[5],
            'career_stage': fixed_data[6]
        },
        'detailed_preferences': dynamic_profile,
        'recent_conversations': [
            {
                'sender': row[0],
                'message': row[1],
                'time': row[2]
            }
            for row in chat_history
        ],
        'ai_insights': [
            {
                'data': row[0],
                'confidence': row[1],
                'extracted_at': row[2]
            }
            for row in insights
        ]
    }


# ä½¿ç”¨ä¾‹
profile = get_comprehensive_user_profile(5001)
print(json.dumps(profile, indent=2, ensure_ascii=False))
```

---

# ğŸ¯ ã¾ã¨ã‚

## âœ… ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿

1. **åŸºæœ¬çš„ãªè¡Œå‹•å±¥æ­´**ï¼ˆuser_interactionsï¼‰
2. **å®Œå…¨ãªä¼šè©±ãƒ†ã‚­ã‚¹ãƒˆ**ï¼ˆchat_historyï¼‰
3. **AIæŠ½å‡ºæƒ…å ±**ï¼ˆextracted_insightsï¼‰
4. **å›ºå®šã‚«ãƒ©ãƒ **ï¼ˆuser_profileï¼‰
5. **æŸ”è»ŸJSONB**ï¼ˆuser_dynamic_profileï¼‰
6. **ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°ãƒ™ã‚¯ãƒˆãƒ«**ï¼ˆuser_embedding_historyï¼‰

## âœ… æŸ”è»Ÿæ€§ã®å®Ÿç¾æ–¹æ³•

- **å›ºå®šã‚«ãƒ©ãƒ **: ã‚ˆãä½¿ã†æƒ…å ±ï¼ˆé«˜é€Ÿï¼‰
- **JSONB**: äºˆæ¸¬ä¸èƒ½ãªæƒ…å ±ï¼ˆæŸ”è»Ÿï¼‰
- **ãƒ†ã‚­ã‚¹ãƒˆ**: å®Œå…¨ãªä¼šè©±ä¿å­˜ï¼ˆå†è§£æå¯èƒ½ï¼‰
- **ã‚¨ãƒ³ãƒ™ãƒ‡ã‚£ãƒ³ã‚°**: æ„å‘³æ¤œç´¢ï¼ˆAIæ´»ç”¨ï¼‰

## âœ… ãªãœã“ã®è¨­è¨ˆãªã®ã‹

```
è³ªå•: æ–°ã—ã„è³ªå•ã«å¯¾å¿œã§ãã‚‹ã®ã‹ï¼Ÿ
å›ç­”: ã§ãã¾ã™ï¼

ç†ç”±:
1. ä¼šè©±ã¯å®Œå…¨ãƒ†ã‚­ã‚¹ãƒˆã§ä¿å­˜
2. AIãŒéšæ™‚å†è§£æ
3. JSONBã§æŸ”è»Ÿã«ä¿å­˜
4. ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ä¸è¦

ä¾‹:
- ä»Šæ—¥ã€Œå‰¯æ¥­ã€ã«ã¤ã„ã¦èãå§‹ã‚ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œå‰¯æ¥­ã—ãŸã„ã§ã™ã€
- chat_history ã«ä¿å­˜
- AIãŒã€Œå‰¯æ¥­å¸Œæœ›ã€ã‚’æŠ½å‡º
- JSONBã«è¿½åŠ : {"side_job": "å¸Œæœ›"}
- å³åº§ã«æ¤œç´¢å¯èƒ½ï¼
```

---

**ã“ã®è¨­è¨ˆã§ã€ç„¡é™ã«é€²åŒ–ã§ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œæˆã—ã¾ã™ï¼** ğŸš€
